<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Baxing Energy Analyzer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body {
            background-color: #f0f2f5;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        .container {
            max-width: 600px;
            width: 100%;
        }
        .card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }
        .card-title {
            font-weight: 700;
            color: #333;
        }
        .btn-primary {
            background-color: #007bff;
            border-color: #007bff;
            padding: 10px;
            font-size: 1.1rem;
            font-weight: 600;
        }
        .btn-secondary {
            background-color: #6c757d;
            border-color: #6c757d;
        }
        .form-control:focus {
            box-shadow: 0 0 0 0.25rem rgba(0, 123, 255, 0.25);
        }
        .result-card, .translated-card {
            background-color: #fff;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            transition: transform 0.2s;
        }
        .result-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        .auspicious {
            border-left: 5px solid #28a745; /* Green */
        }
        .inauspicious {
            border-left: 5px solid #dc3545; /* Red */
        }
        .neutral {
            border-left: 5px solid #ffc107; /* Yellow */
        }
        .info-title {
            font-weight: bold;
            color: #0056b3;
        }
        .details {
            white-space: pre-wrap;
            color: #555;
            font-size: 0.95rem;
        }
        .translated-string {
            font-weight: bold;
            font-family: monospace;
            color: #d63384;
            word-wrap: break-word;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <div id="capture-area">
                <div class="card-body">
                    <h1 class="card-title text-center mb-4">八星能量分析器</h1>
                    <form id="analyze-form">
                        <div class="mb-3">
                            <label for="phone_number" class="form-label">输入数字或字母组合</label>
                            <input type="text" class="form-control" id="phone_number" name="phone_number" placeholder="例如: 13988888888, AR-89T6" required>
                        </div>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary">分析</button>
                        </div>
                    </form>
                    <div id="translated-string-container" class="mt-4"></div>
                    <div id="results" class="mt-2"></div>
                </div>
            </div>
            <div id="share-button-container" class="card-footer bg-transparent border-0 p-3"></div>
        </div>
    </div>

    <script src="script.js"></script>
    <script>
        document.getElementById('analyze-form').addEventListener('submit', function(event) {
            event.preventDefault();
            const phoneNumber = document.getElementById('phone_number').value;
            const resultsDiv = document.getElementById('results');
            const translatedDiv = document.getElementById('translated-string-container');
            const shareBtnContainer = document.getElementById('share-button-container');
            
            resultsDiv.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></div>';
            translatedDiv.innerHTML = '';
            shareBtnContainer.innerHTML = ''; // Clear previous button

            // Call the local JavaScript function from script.js
            const data = analyzePhoneNumber(phoneNumber);

            // Clear spinner
            resultsDiv.innerHTML = '';

            if (data.error) {
                resultsDiv.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                return;
            }

            // Render translated string
            if (data.translated) {
                translatedDiv.innerHTML = `
                    <div class="translated-card">
                        <div class="info-title">转换后序列:</div>
                        <div class="translated-string">${data.translated}</div>
                    </div>
                `;
            }

            // Render results
            data.results.forEach(result => {
                let cardHtml = '';
                if (result.type === 'pair') {
                    const cardClass = result.is_auspicious ? 'auspicious' : (result.is_inauspicious ? 'inauspicious' : 'neutral');
                    cardHtml = `
                        <div class="result-card ${cardClass}">
                            <div class="info-title">${result.info} (组合: ${result.combinations.join(', ')})</div>
                            <div class="details">${result.details}</div>
                        </div>
                    `;
                } else if (result.type === 'special_combination') {
                     cardHtml = `
                        <div class="result-card neutral">
                            <div class="info-title">特殊组合: ${result.combination} (${result.first_pair} + ${result.second_pair})</div>
                            <div class="details">${result.explanation}</div>
                        </div>
                    `;
                } else if (result.type === 'zero_effect') {
                    cardHtml = `
                        <div class="result-card neutral">
                            <div class="info-title">特殊数字影响 (0)</div>
                            <div class="details">${result.explanation}</div>
                        </div>
                    `;
                } else if (result.type === 'five_effect') {
                    cardHtml = `
                        <div class="result-card neutral">
                            <div class="info-title">特殊数字影响 (5)</div>
                            <div class="details">${result.explanation}</div>
                        </div>
                    `;
                } else if (result.type === 'tail_analysis') {
                     cardHtml = `
                        <div class="result-card neutral">
                            <div class="info-title">尾号分析</div>
                            <div class="details">${result.content}</div>
                        </div>
                    `;
                }
                resultsDiv.innerHTML += cardHtml;
            });

            // Add action buttons after rendering results
            if (data.results.length > 0) {
                shareBtnContainer.classList.add('d-grid', 'gap-2', 'd-md-flex', 'justify-content-md-end');

                // 1. Save as Image Button
                const saveButton = document.createElement('button');
                saveButton.textContent = '保存为图片';
                saveButton.className = 'btn btn-secondary';
                shareBtnContainer.appendChild(saveButton);

                saveButton.addEventListener('click', function() {
                    const captureArea = document.getElementById('capture-area');
                    html2canvas(captureArea, { 
                        useCORS: true, 
                        scale: 2,
                        width: captureArea.offsetWidth,
                        backgroundColor: '#f0f2f5'
                    }).then(canvas => {
                        const link = document.createElement('a');
                        link.download = 'baxing-analysis.png';
                        link.href = canvas.toDataURL("image/png").replace("image/png", "image/octet-stream");
                        link.click();
                    });
                });

                // 2. Copy to Clipboard Button
                const copyButton = document.createElement('button');
                copyButton.textContent = '复制图片';
                copyButton.className = 'btn btn-info';
                shareBtnContainer.appendChild(copyButton);

                if (!navigator.clipboard || !navigator.clipboard.write) {
                    copyButton.disabled = true;
                    copyButton.title = '此功能需要通过本地服务器 (localhost) 访问才能使用';
                } else {
                    copyButton.addEventListener('click', function() {
                        const originalText = copyButton.textContent;
                        copyButton.textContent = '复制中...';
                        copyButton.disabled = true;

                        const captureArea = document.getElementById('capture-area');
                        html2canvas(captureArea, { 
                            useCORS: true, 
                            scale: 2, 
                            width: captureArea.offsetWidth, 
                            backgroundColor: '#f0f2f5' 
                        }).then(canvas => {
                            canvas.toBlob(function(blob) {
                                if (blob) {
                                    navigator.clipboard.write([
                                        new ClipboardItem({ 'image/png': blob })
                                    ]).then(function() {
                                        copyButton.textContent = '已复制!';
                                        setTimeout(() => {
                                            copyButton.textContent = originalText;
                                            copyButton.disabled = false;
                                        }, 2000);
                                    }).catch(function(err) {
                                        console.error('无法复制图片: ', err);
                                        copyButton.textContent = '复制失败';
                                        alert('无法复制图片，请检查浏览器权限或通过控制台查看错误。');
                                        setTimeout(() => {
                                            copyButton.textContent = originalText;
                                            copyButton.disabled = false;
                                        }, 3000);
                                    });
                                }
                            }, 'image/png');
                        });
                    });
                }
            }
        });
    </script>
</body>
</html>

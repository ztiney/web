        function analyzeTailNumbers(translatedStr) {
            // 分析尾号的吉凶
            const results = [];
            
            // 只取后六位进行分析
            let tailStr = translatedStr;
            if (translatedStr.length > 6) {
                tailStr = translatedStr.slice(-6);
            }
            
            // 如果后两位包含0或5，则分析后三位
            const lastTwo = tailStr.length >= 2 ? tailStr.slice(-2) : tailStr;
            const hasZeroOrFive = lastTwo.includes('0') || lastTwo.includes('5');
            
            // 特别处理如409这样的情况：检查是否可以通过跳过0形成有效组合
            let skipZeroCombinationFound = false;
            let skipZeroPair = null;
            if (tailStr.length >= 3 && tailStr.charAt(tailStr.length - 2) === '0' && /[1-9]/.test(tailStr.charAt(tailStr.length - 1))) {
                // 检查前一位数字与最后一位数字组成的组合（跳过0）
                skipZeroPair = tailStr.charAt(tailStr.length - 3) + tailStr.charAt(tailStr.length - 1);
                if (data[skipZeroPair]) {
                    skipZeroCombinationFound = true;
                }
            }
            
            if ((hasZeroOrFive && tailStr.length >= 3) || skipZeroCombinationFound) {
                // 分析后三位
                const lastThree = tailStr.slice(-3);
                let analysis = `尾号分析（后三位 ${lastThree}）：\\n`;
                
                // 分析每一位数字
                for (let i = 0; i < lastThree.length; i++) {
                    const digit = lastThree.charAt(i);
                    const position = ["倒数第三位", "倒数第二位", "最后一位"][i];
                    if (digit === '0') {
                        analysis += `- ${position}数字${digit}：代表'空'，意味着能量被削弱或隐藏。\\n`;
                    } else if (digit === '5') {
                        analysis += `- ${position}数字${digit}：有'凸显'、'加强'的含义，可能加强相邻数字的能量。\\n`;
                    } else {
                        // 检查是否能组成数字对
                        if (i < lastThree.length - 1) {
                            const pair = digit + lastThree.charAt(i + 1);
                            if (data[pair]) {
                                const starInfo = data[pair][0];
                                const firstLine = starInfo.split('\\n')[0];
                                analysis += `- ${position}数字组合${pair}：${firstLine}\\n`;
                            }
                        }
                    }
                }
                
                // 特别处理跳过0的组合（如409中的49）
                if (lastThree.length >= 3 && lastThree.charAt(1) === '0') {
                    const skipZeroPair = lastThree.charAt(0) + lastThree.charAt(2);
                    if (data[skipZeroPair]) {
                        const starInfo = data[skipZeroPair][0];
                        const firstLine = starInfo.split('\\n')[0];
                        analysis += `- 跳过中间0的数字组合${skipZeroPair}：${firstLine}（因0的存在，此为间接组合）\\n`;
                    }
                }
                
                // 处理多个0和5的复杂情况
                // 检查是否有其他跳过数字的组合可能性
                if (lastThree.length >= 3) {
                    // 检查第一位和第三位的组合（跳过中间位）
                    const firstLastPair = lastThree.charAt(0) + lastThree.charAt(2);
                    if (data[firstLastPair] && (skipZeroPair === null || firstLastPair !== skipZeroPair)) {
                        const starInfo = data[firstLastPair][0];
                        const firstLine = starInfo.split('\\n')[0];
                        const middleDigit = lastThree.charAt(1);
                        if (middleDigit === '0') {
                            analysis += `- 跳过中间0的数字组合${firstLastPair}：${firstLine}（因0的存在，此为间接组合）\\n`;
                        } else if (middleDigit === '5') {
                            analysis += `- 跳过中间5的数字组合${firstLastPair}：${firstLine}（因5的存在，此组合可能被加强）\\n`;
                        }
                    }
                }
                
                results.push({
                    type: 'tail_analysis',
                    content: analysis
                });
            } else {
                // 分析后两位
                const lastTwo = tailStr.length >= 2 ? tailStr.slice(-2) : tailStr;
                let analysis = `尾号分析（后两位 ${lastTwo}）：\\n`;
                
                if (data[lastTwo]) {
                    const starInfo = data[lastTwo][0];
                    let starName = null;
                    for (const star of auspicious_stars.concat(inauspicious_stars)) {
                        if (starInfo.includes(star)) {
                            starName = star;
                            break;
                        }
                    }
                    
                    if (starName) {
                        if (auspicious_stars.includes(starName)) {
                            analysis += `- 吉星结尾：${starName}，通常代表好的结果。`;
                            if (starName === '天医') {
                                analysis += "可能意味着财运好或感情顺利。\\n";
                            } else if (starName === '延年') {
                                analysis += "代表有能力、能守财。\\n";
                            } else if (starName === '生气') {
                                analysis += "代表人缘好，有贵人相助。\\n";
                            }
                        } else if (inauspicious_stars.includes(starName)) {
                            analysis += `- 凶星结尾：${starName}，通常被视为不吉利。`;
                            if (starName === '绝命') {
                                analysis += "可能导致投资失利、负债累累。\\n";
                            } else if (starName === '五鬼') {
                                analysis += "可能带来意外、破财或感情突变。\\n";
                            } else if (starName === '祸害') {
                                analysis += "容易招惹口舌是非。\\n";
                            } else if (starName === '六煞') {
                                analysis += "情感丰富但容易为情所困。\\n";
                            }
                        }
                    } else {
                        const firstLine = starInfo.split('\\n')[0];
                        analysis += `- 数字组合${lastTwo}：${firstLine}\\n`;
                    }
                } else if (lastTwo.includes('0')) {
                    // 特别处理包含0的情况
                    analysis += "- 以'0'结尾：代表'空'，意味着最终可能一无所有，无论是财富、事业还是感情都容易成空。\\n";
                    // 检查0前面的数字是否能组成有效组合
                    if (lastTwo.length === 2 && /[1-9]/.test(lastTwo.charAt(0))) {
                        const prefixPair = lastTwo.charAt(0) + '0';
                        if (data[prefixPair]) {
                            const starInfo = data[prefixPair][0];
                            const firstLine = starInfo.split('\\n')[0];
                            analysis += `- 数字组合${prefixPair}：${firstLine}（但因0的存在，能量可能被削弱）\\n`;
                        } else {
                            // 即使不是有效组合，也说明0对前面数字的影响
                            analysis += `- 数字'${lastTwo.charAt(0)}'受后面的0影响，其能量可能被削弱或隐藏。\\n`;
                        }
                    }
                } else {
                    analysis += "- 未找到对应的八星能量信息。\\n";
                }
                
                results.push({
                    type: 'tail_analysis',
                    content: analysis
                });
            }
            
            return results;
        }

        function analyzeCombinationPattern(translatedStr) {
            // 分析数字组合模式并提供解释
            const results = [];
            
            // 只分析后六位
            let analysisStr = translatedStr;
            if (translatedStr.length > 6) {
                analysisStr = translatedStr.slice(-6);
            }
            
            // 获取所有相邻数字对的信息
            const pairs = [];
            for (let i = 0; i < analysisStr.length - 1; i++) {
                const comb = analysisStr.charAt(i) + analysisStr.charAt(i + 1);
                if (data[comb]) {
                    const pairInfo = {
                        combination: comb,
                        content: data[comb][0],
                        is_auspicious: auspicious_stars.some(star => data[comb][0].includes(star)),
                        is_inauspicious: inauspicious_stars.some(star => data[comb][0].includes(star)),
                        position: i,
                        first_digit: analysisStr.charAt(i),
                        second_digit: analysisStr.charAt(i + 1)
                    };
                    pairs.push(pairInfo);
                }
            }
            
            // 分析特殊组合
            for (let i = 0; i < pairs.length - 1; i++) {
                const currentPair = pairs[i];
                const nextPair = pairs[i + 1];
                
                // 提取星名
                let currentStar = null;
                let nextStar = null;
                
                for (const star of auspicious_stars.concat(inauspicious_stars)) {
                    if (currentPair.content.includes(star)) {
                        currentStar = star;
                    }
                    if (nextPair.content.includes(star)) {
                        nextStar = star;
                    }
                }
                
                if (currentStar && nextStar) {
                    const comboKey = `${currentStar}+${nextStar}`;
                    if (special_combinations[comboKey]) {
                        // 特殊组合应该是3位数：第一个数字对的第一个数字 + 第一个数字对 + 第二个数字对的第二个数字
                        // 例如：41 + 13 -> 413
                        const specialCombinationDigits = currentPair.combination + nextPair.second_digit;
                        results.push({
                            type: 'special_combination',
                            combination: specialCombinationDigits,
                            first_pair: currentPair.combination,
                            second_pair: nextPair.combination,
                            explanation: special_combinations[comboKey]
                        });
                    }
                }
            }
            
            // 分析0和5的影响（只分析后六位内的0和5）
            for (let i = 0; i < analysisStr.length; i++) {
                const char = analysisStr.charAt(i);
                if (char === '0') {
                    results.push({
                        type: 'zero_effect',
                        position: i,
                        explanation: '数字"0"代表"隐藏"、"空虚"或"能量被削弱"。它可能使相邻数字的能量被隐藏或削弱。'
                    });
                } else if (char === '5') {
                    results.push({
                        type: 'five_effect',
                        position: i,
                        explanation: '数字"5"有"凸显"、"加强"的含义，可能加强相邻数字的能量。'
                    });
                }
            }
            
            return results;
        }

        async function findMatches() {
            const inputStr = document.getElementById('input_str').value;
            const loadingElement = document.getElementById('loading');
            const resultsElement = document.getElementById('results');
            const resultsContentElement = document.getElementById('results-content');
            
            if (!inputStr.trim()) {
                alert('请输入数字或字母');
                return;
            }
            
            // 显示加载状态
            loadingElement.style.display = 'block';
            resultsElement.style.display = 'none';
            
            try {
                // 转换输入（保留0）
                const translatedStr = translateInput(inputStr);
                
                // 只分析后六位
                let analysisStr = translatedStr;
                if (translatedStr.length > 6) {
                    analysisStr = translatedStr.slice(-6);
                }
                
                // 找出所有相邻的数字对
                const pairs = [];
                for (let i = 0; i < analysisStr.length - 1; i++) {
                    const comb = analysisStr.charAt(i) + analysisStr.charAt(i + 1);
                    if (data[comb]) {
                        pairs.push({
                            combination: comb,
                            content: data[comb][0]
                        });
                    }
                }
                
                // 分析组合模式
                const combinationResults = analyzeCombinationPattern(translatedStr);
                
                // 分析尾号
                const tailResults = analyzeTailNumbers(translatedStr);
                
                // 准备返回结果
                const results = [];
                
                // 添加数字对分析
                for (const pair of pairs) {
                    // 提取星名和类型
                    const contentLines = pair.content.split('\\n');
                    const starInfo = contentLines[0];
                    const starDetails = contentLines.slice(1).join('\\n');
                    
                    // 判断是否为吉星或凶星
                    const isAuspicious = auspicious_stars.some(star => starInfo.includes(star));
                    const isInauspicious = inauspicious_stars.some(star => starInfo.includes(star));
                    
                    results.push({
                        type: 'pair',
                        combination: pair.combination,
                        info: starInfo,
                        details: starDetails,
                        is_auspicious: isAuspicious,
                        is_inauspicious: isInauspicious
                    });
                }
                
                // 添加组合模式分析
                results.push(...combinationResults);
                
                // 添加尾号分析
                results.push(...tailResults);
                
                if (results.length > 0) {
                    // 格式化结果显示，保持顺序
                    let resultsHtml = '';
                    results.forEach(result => {
                        resultsHtml += `<div class="result-item">${formatResult(result)}</div>`;
                    });
                    resultsContentElement.innerHTML = resultsHtml;
                    resultsElement.style.display = 'block';
                } else {
                    resultsContentElement.innerHTML = '<p>未找到匹配的结果。</p>';
                    resultsElement.style.display = 'block';
                }
            } catch (error) {
                resultsContentElement.innerHTML = `<p class="error">错误：${error.message}</p>`;
                resultsElement.style.display = 'block';
            } finally {
                loadingElement.style.display = 'none';
            }
        }
        
        function formatResult(result) {
            // 检查result是否为对象
            if (typeof result === 'object' && result !== null) {
                // 确保result有必要的属性
                if (!result.type) {
                    // 如果没有type属性，尝试安全地转换为字符串
                    try {
                        return JSON.stringify(result).replace(/\\n/g, '<br>');
                    } catch (e) {
                        return '[无法显示的结果]';
                    }
                }
                
                const type = result.type;
                
                // 特殊处理不同类型的分析结果
                if (type === 'pair' && result.info && result.details) {
                    // 处理数字对分析结果
                    let html = '';
                    // 显示数字对
                    if (result.combination) {
                        html += `<div><strong>数字对: ${result.combination}</strong></div>`;
                    }
                    if (result.is_auspicious) {
                        html += `<div class="auspicious">${result.info.replace(/\\n/g, '<br>')}</div>`;
                    } else if (result.is_inauspicious) {
                        html += `<div class="inauspicious">${result.info.replace(/\\n/g, '<br>')}</div>`;
                    } else {
                        html += `<div class="neutral">${result.info.replace(/\\n/g, '<br>')}</div>`;
                    }
                    html += `<div class="explanation">${result.details.replace(/\\n/g, '<br>')}</div>`;
                    return html;
                } else if (type === 'special_combination' && result.explanation) {
                    // 处理特殊组合分析结果
                    let html = '';
                    // 显示组合
                    if (result.combination) {
                        html += `<div><strong>特殊组合: ${result.combination}</strong></div>`;
                    }
                    // 显示是哪两个数字对的组合
                    if (result.first_pair && result.second_pair) {
                        html += `<div>由数字对 ${result.first_pair} 和 ${result.second_pair} 组成</div>`;
                    }
                    html += `<div class="special_combination">${result.explanation.replace(/\\n/g, '<br>')}</div>`;
                    return html;
                } else if (type === 'zero_effect' && result.position !== undefined && result.explanation) {
                    // 处理0的影响分析结果
                    return `<div class="zero_effect">数字"0"在位置${result.position}：${result.explanation.replace(/\\n/g, '<br>')}</div>`;
                } else if (type === 'five_effect' && result.position !== undefined && result.explanation) {
                    // 处理5的影响分析结果
                    return `<div class="five_effect">数字"5"在位置${result.position}：${result.explanation.replace(/\\n/g, '<br>')}</div>`;
                } else if (type === 'tail_analysis' && result.content) {
                    // 处理尾号分析结果
                    return `<div class="ending_warning">${result.content.replace(/\\n/g, '<br>')}</div>`;
                } else if (result.content) {
                    // 默认处理方式，使用content属性
                    const lines = result.content.split('\\n');
                    if (lines.length > 0) {
                        lines[0] = `<span class="${type}">${lines[0]}</span>`;
                    }
                    return lines.join('<br>');
                } else {
                    // 如果有type但没有content，尝试安全地显示其他属性
                    try {
                        let display = `<div class="${type}">类型: ${type}</div>`;
                        for (let key in result) {
                            if (key !== 'type' && result.hasOwnProperty(key)) {
                                display += `<div>${key}: ${String(result[key]).replace(/\\n/g, '<br>')}</div>`;
                            }
                        }
                        return display;
                    } catch (e) {
                        return `<div class="${type}">类型: ${type}<br>[结果内容无法显示]</div>`;
                    }
                }
            } else {
                // 如果不是对象，按原来的方式处理
                return String(result).replace(/\\n/g, '<br>');
            }
        }
        
        // 添加回车键支持
        document.getElementById('input_str').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                findMatches();
            }
        });
    </script>
</body>
</html>